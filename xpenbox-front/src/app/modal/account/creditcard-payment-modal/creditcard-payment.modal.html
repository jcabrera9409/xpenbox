<!-- Overlay con backdrop -->
<div class="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4 overflow-y-auto">
    <div class="xpb-bg-card rounded-xl shadow-2xl w-full max-w-md mx-auto my-auto max-h-[calc(100vh-2rem)] sm:max-h-[calc(100vh-5rem)] flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="xpb-bg-sidebar px-4 py-3 border-b xpb-border relative flex-shrink-0">
            <div class="flex items-center gap-4">
                <!-- Icon -->
                <div class="xpb-bg-card rounded-lg p-2 shadow-sm">
                    <span class="material-icons text-[var(--xpb-income)] text-2xl">payment</span>
                </div>
                <!-- Title and subtitle -->
                <div class="flex-1">
                    <h3 class="text-xl font-semibold xpb-text-primary">Pago de Tarjeta de Crédito</h3>
                    <p class="text-sm xpb-text-secondary">Realiza el pago de tu tarjeta de crédito</p>
                </div>
                <!-- Close button -->
                <button (click)="onClose()" 
                    class="text-gray-400 hover:text-gray-600 transition-colors -mt-1">
                    <span class="material-icons text-lg">close</span>
                </button>
            </div>
        </div>

        @if (this.creditCardState.isLoadingGetCreditCard() && this.creditCardResourceCode()) {
            <app-loading-ui></app-loading-ui>
        } @else if (this.creditCardState.errorGetCreditCard() && this.creditCardResourceCode()) {
            <app-retry-component
                [message]="'Error al cargar la información de la tarjeta de crédito'"
                (retry)="retryLoadCreditCardData()">
            </app-retry-component>
        } @else {
            <!-- Body -->
            <div class="p-4 overflow-y-auto flex-1">
                <app-virtual-keyboard-ui 
                    [currency]="userLogged()?.currency!"
                    [defaultAmount]="0"
                    (amountOutput)="amount.set($event)">
                </app-virtual-keyboard-ui>

                <!-- Description -->
                <div class="mb-3">
                    <label class="block text-sm font-medium xpb-text-secondary mb-2">
                        Descripción <span class="text-xs xpb-text-secondary">(opcional)</span>
                    </label>
                    <div class="relative">
                        <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 xpb-text-secondary text-lg">description</span>
                        <input 
                            type="text"
                            maxlength="250"
                            [value]="description()"
                            (input)="description.set($any($event.target).value)"
                            placeholder="Ejm: Pago de tarjeta de crédito"
                            class="xpb-bg-main border xpb-border rounded-lg pl-10 pr-4 py-2 w-full xpb-text-primary placeholder:xpb-text-secondary focus:outline-none focus:ring-2 focus:ring-[var(--xpb-primary)] focus:border-transparent transition-all" />
                    </div>
                </div>

                @if (isOnlyOneCreditCard) {
                    <!-- Credit Card (No Editable) -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium xpb-text-secondary mb-2">
                            Tarjeta de Crédito
                        </label>
                        <div class="relative">
                            <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 xpb-text-secondary text-lg">payment</span>
                            <input 
                                type="text"
                                [value]="creditCardData()?.name + ' - ' + userLogged()?.currency + ' ' + (creditCardData()?.balance | number:'1.2-2')"
                                readonly
                                class="xpb-bg-main border xpb-border rounded-lg pl-10 pr-4 py-2 w-full opacity-50" />
                        </div>
                    </div>
                } @else {
                    <!-- Credit Card (Carousel) -->
                    <app-accounts-carousel-component
                        ngSkipHydration class="block"
                        [isLoading]="this.creditCardState.isLoadingGetList()"
                        [errorLoading]="this.creditCardState.errorGetList()"
                        [carouselTitle]="'Tarjeta de Crédito a Pagar'"
                        [carouselErrorMessage]="'Error al cargar tarjetas de crédito'"
                        [currencySymbol]="userLogged()?.currency!"
                        [accountsList]="creditCardList()"
                        [currentSelectedAccount]="creditCardData()"
                        [noAccountsMessage]="'No tienes tarjetas de crédito disponibles'"
                        (selectedAccountOutput)="this.creditCardData.set($event)"
                        (retry)="retryLoadCreditCardsData()">
                    </app-accounts-carousel-component>
                }

                <!-- Destination Account (Carousel) -->
                <app-accounts-carousel-component
                    ngSkipHydration class="block"
                    [isLoading]="this.accountState.isLoadingGetList()"
                    [errorLoading]="this.accountState.errorGetList()"
                    [carouselTitle]="'Cargar a Cuenta'"
                    [carouselErrorMessage]="'Error al cargar cuentas'"
                    [currencySymbol]="userLogged()?.currency!"
                    [accountsList]="accountsList()"
                    [currentSelectedAccount]="selectedAccount()"
                    [noAccountsMessage]="'No tienes cuentas disponibles'"
                    (selectedAccountOutput)="this.selectedAccount.set($event)"
                    (retry)="retryLoadAccountsData()">
                </app-accounts-carousel-component>

                <!-- Checkbox para asignar a categoría -->
                <div class="mb-4">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="relative">
                            <input
                                type="checkbox"
                                [checked]="assignToCategory()"
                                (change)="assignToCategory.set(!assignToCategory())"
                                class="peer sr-only" />
                            <div class="w-5 h-5 border-2 xpb-border rounded transition-all peer-checked:bg-[var(--xpb-primary)] peer-checked:border-[var(--xpb-primary)] flex items-center justify-center">
                                <span class="material-icons text-white text-sm opacity-0 peer-checked:opacity-100 transition-opacity">check</span>
                            </div>
                        </div>
                        <span class="text-sm font-medium xpb-text-primary group-hover:xpb-text-secondary transition-colors">
                            Agregar a una categoría
                        </span>
                    </label>
                </div>

                @if (assignToCategory()) {
                    <app-categories-carousel-component
                        (outputCategory)="selectCategory($event)">
                    </app-categories-carousel-component>
                }

                @if (this.transactionState.errorSendingTransaction()) {
                    <div class="flex items-start gap-2 xpb-bg-main rounded-lg p-3 border-l-4 border-[var(--xpb-expense)]">
                        <span class="material-icons text-[var(--xpb-expense)] text-lg mt-0.5">error_outline</span>
                        <div class="text-sm text-[var(--xpb-expense)] flex-1">
                            {{ this.transactionState.errorSendingTransaction() }}
                        </div>
                    </div>
                }

                <!-- Actions Buttons -->
                <app-modal-buttons-ui
                    [cancelText]="'Cancelar'"
                    [cancelIcon]="'close'"
                    [isEditMode]="false"
                    [isLoading]="this.transactionState.isLoadingSendingTransaction()"
                    [isValidForm]="isFormValid"
                    [loadingText]="'Pagando...'"
                    [loadingIcon]="'autorenew'"
                    [confirmText]="'Pagar'"
                    [confirmIcon]="'payment'"
                    (cancel)="onClose()"
                    (confirm)="onSubmit()">
                </app-modal-buttons-ui>
            </div>
        }

    </div>
</div>