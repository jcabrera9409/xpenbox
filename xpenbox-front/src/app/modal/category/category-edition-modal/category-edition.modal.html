<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
    <div class="xpb-bg-card rounded-xl shadow-2xl w-full max-w-md mx-auto overflow-hidden">
        <!-- Header -->
        <div class="xpb-bg-sidebar px-6 py-5 border-b xpb-border">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <div class="xpb-bg-card rounded-lg p-2 shadow-sm">
                        <span class="material-icons text-[var(--xpb-primary)] text-2xl">
                            @if (isEditMode) {
                                edit
                            } @else {
                                category
                            }
                        </span>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold xpb-text-primary">
                            @if (isEditMode) {
                                Modificar Categoría
                            } @else {
                                Nueva Categoría
                            }
                        </h2>
                        <p class="text-sm xpb-text-secondary">
                            @if (isEditMode) {
                                Actualiza la información de tu categoría
                            } @else {
                                Registra una nueva categoría para tus transacciones
                            }
                        </p>
                    </div>
                </div>
                <button
                    type="button"
                    (click)="onClose()"
                    class="xpb-text-secondary hover:xpb-text-primary hover:bg-[var(--xpb-main)] rounded-lg p-2 transition-colors"
                    aria-label="Cerrar modal"
                >
                    <span class="material-icons text-2xl">close</span>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6">
            @if (this.categoryState.isLoadingGetCategory() && isEditMode) {
                <app-loading-ui></app-loading-ui>
            } @else if(this.categoryState.errorGetCategory() && isEditMode) {
                <app-retry-component
                    [message]="'Error al cargar la categoría'"
                    (retry)="retryLoadCategoryData()">
                </app-retry-component>
            } @else if(categoryData() || !isEditMode) {
                <form [formGroup]="formCategory" (ngSubmit)="onSubmit()" class="flex flex-col gap-5">
                    <!-- Nombre de la categoría -->
                    <div>
                        <label for="name" class="block text-sm font-medium xpb-text-primary mb-2">
                            Nombre de la categoría
                        </label>
                        <div class="relative">
                            <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 xpb-text-secondary text-xl">
                                category
                            </span>
                            <input 
                                id="name" 
                                type="text" 
                                formControlName="name"
                                class="xpb-bg-main border xpb-border rounded-lg pl-11 pr-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-[var(--xpb-primary)] focus:border-transparent transition-all"
                                placeholder="Ej: Categoría de Gastos/Ingresos"
                                maxlength="25" 
                                autocomplete="off" 
                                aria-required="true" 
                                aria-label="Nombre de la categoría" 
                            />
                        </div>
                        @if (formCategory.get('name')?.touched && formCategory.get('name')?.invalid) {
                            <div class="mt-2 flex items-start gap-2 xpb-bg-main rounded-lg p-3 border-l-4 border-[var(--xpb-expense)]">
                                <span class="material-icons text-[var(--xpb-expense)] text-lg mt-0.5">info</span>
                                <div class="text-sm text-[var(--xpb-expense)] flex-1">
                                    @if (formCategory.get('name')?.errors?.['required']) {
                                        <p>El nombre es obligatorio.</p>
                                    }
                                    @if (formCategory.get('name')?.errors?.['minlength']) {
                                        <p>Debe tener mínimo 3 caracteres.</p>
                                    }
                                    @if (formCategory.get('name')?.errors?.['maxlength']) {
                                        <p>Máximo 25 caracteres.</p>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Color de la categoría -->
                     <div>
                        <label for="color" class="block text-sm font-medium xpb-text-primary mb-2">
                            Color de la categoría
                        </label>
                        <div class="flex items-center gap-3">
                            <!-- Preview del color seleccionado -->
                            <div 
                                class="w-16 h-16 rounded-xl border-2 xpb-border shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-[var(--xpb-primary)] cursor-pointer"
                                [style.background-color]="formCategory.get('color')?.value"
                                (click)="colorInput.click()"
                                title="Haz clic para cambiar el color"
                            ></div>
                            
                            <!-- Input y valor hex -->
                            <div class="flex-1">
                                <div class="relative">
                                    <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 xpb-text-secondary text-xl">
                                        color_lens
                                    </span>
                                    <input 
                                        #colorInput
                                        id="color" 
                                        type="color" 
                                        formControlName="color"
                                        class="absolute left-0 top-0 w-full h-full opacity-0 cursor-pointer"
                                        aria-required="true" 
                                        aria-label="Color de la categoría" 
                                    />
                                    <input 
                                        type="text"
                                        [value]="formCategory.get('color')?.value"
                                        readonly
                                        (click)="colorInput.click()"
                                        class="xpb-bg-main border xpb-border rounded-lg pl-11 pr-4 py-2.5 w-full focus:outline-none focus:ring-2 focus:ring-[var(--xpb-primary)] focus:border-transparent transition-all cursor-pointer uppercase font-mono text-sm relative"
                                        placeholder="#000000"
                                    />
                                </div>
                                <p class="text-xs xpb-text-secondary mt-1.5 ml-1">
                                    Haz clic en el cuadro o el código para cambiar
                                </p>
                            </div>
                        </div>
                        @if (formCategory.get('color')?.touched && formCategory.get('color')?.invalid) {
                            <div class="mt-2 flex items-start gap-2 xpb-bg-main rounded-lg p-3 border-l-4 border-[var(--xpb-expense)]">
                                <span class="material-icons text-[var(--xpb-expense)] text-lg mt-0.5">info</span>
                                <div class="text-sm text-[var(--xpb-expense)] flex-1">
                                    @if (formCategory.get('color')?.errors?.['required']) {
                                        <p>El color es obligatorio.</p>
                                    }
                                    @if (formCategory.get('color')?.errors?.['pattern']) {
                                        <p>El color debe ser un valor hexadecimal válido.</p>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Mensaje de error al enviar -->
                    @if (this.categoryState.errorSendingCategory()) {
                        <div class="flex items-start gap-2 xpb-bg-main rounded-lg p-3 border-l-4 border-[var(--xpb-expense)]">
                            <span class="material-icons text-[var(--xpb-expense)] text-lg mt-0.5">error_outline</span>
                            <div class="text-sm text-[var(--xpb-expense)] flex-1">
                                {{ this.categoryState.errorSendingCategory() }}
                            </div>
                        </div>
                    }

                    <!-- Botones de acción -->
                    <app-modal-buttons-ui
                        [cancelText]="'Cancelar'"
                        [cancelIcon]="'close'"
                        [isEditMode]="isEditMode"
                        [isLoading]="this.categoryState.isLoadingSendingCategory()"
                        [isValidForm]="formCategory.valid"
                        [loadingText]="'Guardando...'"
                        [loadingIcon]="'autorenew'"
                        [confirmText]="'Registrar'"
                        [confirmIcon]="'add'"
                        [confirmEditText]="'Actualizar'"
                        [confirmEditIcon]="'check'"
                        (cancel)="onClose()">
                    </app-modal-buttons-ui>
                </form>
            }
        </div>
    </div>
</div>

