<!-- Top Header (Desktop & Mobile) -->
<header class="fixed top-0 left-0 right-0 h-16 xpb-bg-card border-b xpb-border shadow-sm z-48">
  <div class="flex items-center h-full">
    <!-- Logo Section (Desktop only - aligned with sidebar) -->
    <div class="hidden lg:flex lg:items-center lg:justify-start lg:w-64 lg:px-6 lg:xpb-border">
      <h1 class="text-2xl font-bold xpb-text-primary">XpenBox</h1>
    </div>

    <!-- Mobile Menu Toggle Button -->
    <button
      (click)="toggleMobileMenu()"
      class="lg:hidden p-2 rounded-lg hover:xpb-bg-sidebar transition-colors ml-4"
      aria-label="Toggle menu"
    >
      <span class="material-icons xpb-text-primary text-2xl">
        {{ isMobileMenuOpen() ? 'close' : 'menu' }}
      </span>
    </button>

    <!-- User Profile (Mobile only) -->
    <div class="lg:hidden flex items-center gap-3 px-4">
      <img
        src="https://api.dicebear.com/9.x/identicon/svg?seed={{this.userName }}"
        [alt]="this.userName"
        class="w-10 h-10 rounded-full object-cover border-2 xpb-border"
      />
      <div class="flex flex-col">
        @if (this.userState.isLoading()) {
          <span class="text-xs xpb-text-secondary">Cargando...</span>
        } @else {
          <span class="text-xs xpb-text-secondary">Hola</span>
          <span class="font-medium xpb-text-primary text-sm">{{ this.userName }}</span>
        }
      </div>
    </div>

    <!-- Spacer -->
    <div class="flex-1"></div>

    <!-- Right Section: Profile & Notifications -->
    <div class="flex items-center gap-3 lg:gap-4 px-4 lg:px-6">
      <!-- User Profile (Desktop only) -->
      <div class="hidden lg:flex items-center gap-3">
        <img
          src="https://api.dicebear.com/9.x/identicon/svg?seed={{this.userName }}"
          [alt]="this.userName"
          class="w-10 h-10 rounded-full object-cover border-2 xpb-border"
        />
        <div class="flex flex-col">
          @if (this.userState.isLoading()) {
            <span class="text-xs xpb-text-secondary">Cargando...</span>
          } @else {
            <span class="text-xs xpb-text-secondary">Hola</span>
            <span class="font-medium xpb-text-primary text-sm">{{ this.userName }}</span>
          }
        </div>
      </div>

      <!-- Notifications -->
      <button
        style="display: none;"
        class="relative p-2 rounded-lg hover:xpb-bg-sidebar transition-colors"
        aria-label="Notificaciones"
      >
        <span class="material-icons xpb-text-secondary">notifications</span>
        @if (notificationCount() > 0) {
          <span
            class="absolute top-1 right-1 w-5 h-5 bg-[var(--xpb-expense)] text-white text-xs font-bold rounded-full flex items-center justify-center"
          >
            {{ notificationCount() }}
          </span>
        }
      </button>
    </div>
  </div>
</header>

<!-- Mobile Menu Backdrop -->
@if (isMobileMenuOpen()) {
  <div
    (click)="closeMobileMenu()"
    class="lg:hidden fixed inset-0 bg-black/50 z-52 top-16"
  ></div>
}

<!-- Desktop Sidebar Menu / Mobile Drawer -->
<aside
  [class]="isMobileMenuOpen() ? 'translate-x-0' : '-translate-x-full'"
  class="lg:translate-x-0 flex flex-col fixed left-0 top-16 bottom-0 w-64 xpb-bg-sidebar border-r xpb-border shadow-sm z-52 transition-transform duration-300 ease-in-out lg:shadow-none"
>
  <!-- Navigation Links -->
  <nav class="flex-1 p-4 space-y-2">
    @for (item of menuItemsDesktop; track item.route) {
      <a
        [routerLink]="item.route"
        (click)="closeMobileMenu()"
          routerLinkActive="xpb-bg-card shadow-sm"
          [routerLinkActiveOptions]="{ exact: true }"
        class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all hover:xpb-bg-card hover:shadow-sm"
      >
        <span class="material-icons xpb-text-secondary">{{ item.icon }}</span>
        <span class="font-medium xpb-text-primary">{{ item.label }}</span>
      </a>
    }
  </nav>

  <!-- Quick Expense Button -->
  <div class="p-4 border-t xpb-border">
    <button
      (click)="onQuickExpense()"
      class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-[var(--xpb-primary)] hover:bg-[var(--xpb-primary-hover)] text-white font-medium transition-colors shadow-md"
    >
      <span class="material-icons">add</span>
      <span>Registrar Gasto</span>
    </button>
  </div>
</aside>

<!-- Speed Dial Backdrop -->
@if (isSpeedDialOpen() || isSpeedDialClosing()) {
  <div
    (click)="closeSpeedDial()"
    [class.opacity-0]="isSpeedDialClosing()"
    class="lg:hidden fixed inset-0 bg-black/50 z-[49] transition-opacity duration-300"
  ></div>
}

<!-- Speed Dial Actions -->
@if (isSpeedDialOpen() || isSpeedDialClosing()) {
  <div class="lg:hidden fixed left-1/2 -translate-x-1/2 bottom-30 z-[50] flex flex-col-reverse gap-3">
    <!-- Gasto Rápido -->
    <button
      (click)="onQuickExpense()"
      class="flex items-center gap-3 xpb-bg-card rounded-full shadow-xl pl-4 pr-5 py-3 hover:scale-105 transition-transform"
      [class.animate-speed-dial-in-1]="!isSpeedDialClosing()"
      [class.animate-speed-dial-out-1]="isSpeedDialClosing()"
      [style.animation-delay]="isSpeedDialClosing() ? '150ms' : '0ms'"
    >
      <div class="w-10 h-10 rounded-full bg-[var(--xpb-expense)] flex items-center justify-center">
        <span class="material-icons text-white text-xl">receipt_long</span>
      </div>
      <span class="font-medium xpb-text-primary whitespace-nowrap">Registrar Gasto</span>
    </button>

    <!-- Nuevo Ingreso -->
    <button
      (click)="onQuickIncome()"
      class="flex items-center gap-3 xpb-bg-card rounded-full shadow-xl pl-4 pr-5 py-3 hover:scale-105 transition-transform"
      [class.animate-speed-dial-in-2]="!isSpeedDialClosing()"
      [class.animate-speed-dial-out-2]="isSpeedDialClosing()"
      [style.animation-delay]="isSpeedDialClosing() ? '100ms' : '50ms'"
    >
      <div class="w-10 h-10 rounded-full bg-[var(--xpb-income)] flex items-center justify-center">
        <span class="material-icons text-white text-xl">trending_up</span>
      </div>
      <span class="font-medium xpb-text-primary whitespace-nowrap">Nuevo Ingreso</span>
    </button>

    <!-- Transferencia -->
    <button
      style="display: none;"
      (click)="onQuickTransfer()"
      class="flex items-center gap-3 xpb-bg-card rounded-full shadow-xl pl-4 pr-5 py-3 hover:scale-105 transition-transform"
      [class.animate-speed-dial-in-3]="!isSpeedDialClosing()"
      [class.animate-speed-dial-out-3]="isSpeedDialClosing()"
      [style.animation-delay]="isSpeedDialClosing() ? '50ms' : '100ms'"
    >
      <div class="w-10 h-10 rounded-full bg-[var(--xpb-transfer)] flex items-center justify-center">
        <span class="material-icons text-white text-xl">swap_horiz</span>
      </div>
      <span class="font-medium xpb-text-primary whitespace-nowrap">Transferencia</span>
    </button>

    <!-- Pago de Tarjeta -->
    <button
      style="display: none;"
      (click)="onQuickCreditCardPayment()"
      class="flex items-center gap-3 xpb-bg-card rounded-full shadow-xl pl-4 pr-5 py-3 hover:scale-105 transition-transform"
      [class.animate-speed-dial-in-4]="!isSpeedDialClosing()"
      [class.animate-speed-dial-out-4]="isSpeedDialClosing()"
      [style.animation-delay]="isSpeedDialClosing() ? '0ms' : '150ms'"
    >
      <div class="w-10 h-10 rounded-full bg-[var(--xpb-credit)] flex items-center justify-center">
        <span class="material-icons text-white text-xl">payment</span>
      </div>
      <span class="font-medium xpb-text-primary whitespace-nowrap">Pago de Tarjeta</span>
    </button>
  </div>
}

<!-- Mobile Bottom Navigation -->
<nav class="lg:hidden fixed bottom-0 left-0 right-0 xpb-bg-card border-t xpb-border shadow-lg z-40">
  <div class="flex items-center justify-around h-16 relative">
    @for (item of menuItemsMobile; track item.route; let i = $index) {
      <a
        [routerLink]="item.route"
          routerLinkActive="text-[var(--xpb-primary)]"
          [routerLinkActiveOptions]="{ exact: true }"
        class="flex flex-col items-center justify-center flex-1 h-full xpb-text-secondary transition-colors"
      >
        <span class="material-icons text-2xl">{{ item.icon }}</span>
        <span class="text-xs mt-1">{{ item.label }}</span>
      </a>
    }
  </div>
</nav>

<!-- Central Quick Action Button -->
<button
  (click)="toggleSpeedDial()"
  [class]="isSpeedDialOpen() ? 'rotate-45' : 'rotate-0'"
  class="lg:hidden fixed left-1/2 -translate-x-1/2 bottom-10 w-14 h-14 rounded-full bg-[var(--xpb-primary)] hover:bg-[var(--xpb-primary-hover)] shadow-xl flex items-center justify-center text-white transition-all duration-300 z-[51]"
  aria-label="Acciones rápidas"
>
  <span class="material-icons text-3xl">add</span>
</button>
