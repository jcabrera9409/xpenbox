<!-- Dashboard Principal -->
<div class="xpb-bg-main min-h-screen p-4 md:p-6 lg:p-8">
  <!-- Header con título y panel de control inteligente -->
  <div class="max-w-7xl mx-auto mb-2 lg:mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold xpb-text-primary">Resumen Financiero</h1>
        <p class="text-sm xpb-text-secondary mt-1">Panel de control inteligente</p>
      </div>
      
      <!-- Selector de período -->
      <div class="mb-3">
        <div class="overflow-x-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none] md:[&::-webkit-scrollbar]:block md:[scrollbar-width:thin] md:scrollbar-thin md:scrollbar-thumb-gray-300 md:scrollbar-track-transparent">
            <div class="flex gap-2">
                <button
                  (click)="changePeriod(periodFilter.CURRENT_MONTH)"
                  [disabled]="isPeriodSelected(periodFilter.CURRENT_MONTH)"
                  [class]="isPeriodSelected(periodFilter.CURRENT_MONTH) ? 'bg-[var(--xpb-neutral)]/30 xpb-text-primary font-medium border xpb-border shadow-sm hover:xpb-bg-main' : 'xpb-bg-main xpb-text-secondary hover:xpb-bg-card'"
                  class="px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm whitespace-nowrap transition-colors">
                  Mes Actual
                </button>
                <button 
                  (click)="changePeriod(periodFilter.LAST_MONTH)"
                  [disabled]="isPeriodSelected(periodFilter.LAST_MONTH)"
                  [class]="isPeriodSelected(periodFilter.LAST_MONTH) ? 'bg-[var(--xpb-neutral)]/30 xpb-text-primary font-medium border xpb-border shadow-sm hover:xpb-bg-main' : 'xpb-bg-main xpb-text-secondary hover:xpb-bg-card'"
                  class="px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm whitespace-nowrap transition-colors">
                  Mes Anterior
                </button>
                <button 
                  (click)="changePeriod(periodFilter.LAST_3_MONTHS)"
                  [disabled]="isPeriodSelected(periodFilter.LAST_3_MONTHS)"
                  [class]="isPeriodSelected(periodFilter.LAST_3_MONTHS) ? 'bg-[var(--xpb-neutral)]/30 xpb-text-primary font-medium border xpb-border shadow-sm hover:xpb-bg-main' : 'xpb-bg-main xpb-text-secondary hover:xpb-bg-card'"
                  class="px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm whitespace-nowrap transition-colors">
                  Últimos 3 meses
                </button>
                <button 
                  (click)="changePeriod(periodFilter.LAST_6_MONTHS)"
                  [disabled]="isPeriodSelected(periodFilter.LAST_6_MONTHS)"
                  [class]="isPeriodSelected(periodFilter.LAST_6_MONTHS) ? 'bg-[var(--xpb-neutral)]/30 xpb-text-primary font-medium border xpb-border shadow-sm hover:xpb-bg-main' : 'xpb-bg-main xpb-text-secondary hover:xpb-bg-card'"
                  class="px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm whitespace-nowrap transition-colors">
                  Últimos 6 meses
                </button>
                <button 
                  (click)="changePeriod(periodFilter.CURRENT_YEAR)"
                  [disabled]="isPeriodSelected(periodFilter.CURRENT_YEAR)"
                  [class]="isPeriodSelected(periodFilter.CURRENT_YEAR) ? 'bg-[var(--xpb-neutral)]/30 xpb-text-primary font-medium border xpb-border shadow-sm hover:xpb-bg-main' : 'xpb-bg-main xpb-text-secondary hover:xpb-bg-card'"
                  class="px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm whitespace-nowrap transition-colors">
                  Año Actual
                </button>
                <button 
                  (click)="changePeriod(periodFilter.LAST_YEAR)"
                  [disabled]="isPeriodSelected(periodFilter.LAST_YEAR)"
                  [class]="isPeriodSelected(periodFilter.LAST_YEAR) ? 'bg-[var(--xpb-neutral)]/30 xpb-text-primary font-medium border xpb-border shadow-sm hover:xpb-bg-main' : 'xpb-bg-main xpb-text-secondary hover:xpb-bg-card'"
                  class="px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm whitespace-nowrap transition-colors">
                  Año Anterior
                </button>
            </div>
        </div>
      </div>

    </div>

    <!-- Smart Insight -->
    <div style="display: none;" class="mt-3 xpb-bg-card rounded-lg p-4 border-l-4 border-[var(--xpb-income)] shadow-sm">
      <div class="flex items-start gap-2">
        <span class="material-icons text-[var(--xpb-income)]" style="font-size: 20px;">lightbulb</span>
        <div class="text-xs sm:text-sm">
          <span class="font-semibold xpb-text-primary">Smart Insight:</span>
          <span class="xpb-text-secondary"> Tus gastos bajaron un <span class="font-semibold text-[var(--xpb-income)]">8% respecto al mes anterior</span>. Has ahorrado $420 adicionales este mes. ¡Sigue así!</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid principal -->
  <div class="max-w-7xl mx-auto space-y-6">
    
    <!-- Primera fila: 4 tarjetas de métricas principales -->
    <div class="grid grid-cols-3 lg:grid-cols-9 gap-4">
      
      <!-- Balance General (destacado - 25% más ancho) -->
      @if (this.dashboardState.isLoadingDashboardData()) {
        <div class="items-center col-span-9">
          <app-loading-ui></app-loading-ui>
        </div>
      } @else if (dashboardState.errorDashboardData() || !dashboardData()) {
        <div class="items-center col-span-9">
          <app-retry-component
            [message]="'Error al cargar los datos del dashboard. Por favor, intenta recargar.'"
           (retry)="retryLoadDashboardData()">
          </app-retry-component>
        </div>
      } @else {
        <div [class]="!isCurrentMonthSelected ? '' : percentageChangeBalance() >= 0 ? 'bg-[var(--xpb-income)]/10' : 'bg-[var(--xpb-expense)]/10'"  
              class="col-span-3 rounded-xl px-3 py-3 lg:px-3 lg:py-6 shadow-md border xpb-border">
          <div class="flex items-center justify-between mb-2 lg:mb-4">
            <div class="flex items-center gap-2">
              <div class="rounded-lg p-1 lg:p-2">
                <span class="material-icons text-black/60 text-2xl">account_balance</span>
              </div>
              <p class="text-xs xpb-text-secondary uppercase tracking-wide whitespace-nowrap">Balance General</p>
            </div>
            @if (isCurrentMonthSelected) {
              <div
                [class]="percentageChangeBalance() >= 0 ? 'text-[var(--xpb-income)]' : 'text-[var(--xpb-expense)]'"  
                class="flex items-center gap-1 text-[0.85rem] lg:text-sm font-medium relative">
                  <span class="material-icons">
                    {{ percentageChangeBalance() >= 0 ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                  <span
                    class="font-medium">
                    {{ percentageChangeBalance() >= 0 ? '+' : '-' }}{{ percentageChangeBalanceAbs() | number:'1.2-2' }}%
                  </span>
                  <span 
                    (click)="toggleBalanceTooltip($event)" 
                    class="material-icons opacity-60 cursor-pointer hover:opacity-100 transition-opacity">
                    info_outline
                  </span>
                  <!-- Tooltip personalizado -->
                  @if (showBalanceTooltip()) {
                    <div 
                      (click)="$event.stopPropagation()"
                      class="absolute top-full right-0 mt-2 w-64 xpb-bg-card rounded-lg shadow-lg border xpb-border p-3 z-10 text-xs xpb-text-secondary font-normal">
                      <p class="leading-relaxed">
                        Este porcentaje indica la variación de tu balance actual respecto al mes anterior.
                      </p>
                      <div class="absolute -top-2 right-8 w-0 h-0 border-l-8 border-r-8 border-b-8 border-transparent border-b-[var(--xpb-border)]"></div>
                    </div>
                  }
              </div>
            }
          </div>
          <p class="text-2xl lg:text-3xl font-bold text-black/70 mb-2 break-words">PEN {{ currentBalance() | number:'1.2-2' }}</p>
        </div>
        
        <!-- Resultado del mes -->
        <div class="lg:col-span-2 xpb-bg-card rounded-xl px-1 py-3 lg:px-3 lg:py-6 shadow-sm border xpb-border">
          <div class="flex items-center gap-2 mb-2 lg:mb-3">
            <div class="hidden lg:block">
              <span 
                [class]="netCashFlow() > 0 ? 'text-[var(--xpb-income)]' : netCashFlow() === 0 ? 'text-[var(--xpb-primary)]' : 'text-[var(--xpb-expense)]'"
                class="material-icons text-xl">swap_horiz</span>
            </div>
            <p class="text-xs xpb-text-secondary uppercase tracking-wide whitespace-nowrap hidden lg:block">Resultado del Mes</p>
            <p class="text-[0.6rem] xpb-text-secondary uppercase tracking-wide font-semibold w-full text-center lg:hidden">RESULTADOS</p>
          </div>
          <p 
            [class]="netCashFlow() > 0 ? 'text-[var(--xpb-income)]' : netCashFlow() === 0 ? '' : 'text-[var(--xpb-expense)]'"
            class="text-[0.65rem] lg:text-xl font-semibold mb-1 whitespace-nowrap text-center lg:text-left">
            {{ netCashFlow() > 0 ? '+ PEN ' : netCashFlow() === 0 ? 'PEN ' : '- PEN ' }}{{ netCashFlowAbs() | number:'1.2-2' }}
          </p>
        </div>

        <!-- Ingresos del mes -->
        <div class="lg:col-span-2 xpb-bg-card rounded-xl px-1 py-3 lg:px-3 lg:py-6 shadow-sm border xpb-border">
          <div class="flex items-center gap-2 mb-2 lg:mb-3">
            <div class="hidden lg:block">
              <span class="material-icons text-[var(--xpb-income)] text-xl">trending_up</span>
            </div>
            <p class="text-xs xpb-text-secondary uppercase tracking-wide whitespace-nowrap hidden lg:block">Ingresos del Mes</p>
            <p class="text-[0.6rem] xpb-text-secondary uppercase tracking-wide font-semibold w-full text-center lg:hidden">INGRESOS</p>
          </div>
          <p class="text-[0.65rem] lg:text-xl font-semibold text-[var(--xpb-income)] mb-1 whitespace-nowrap text-center lg:text-left">PEN {{ incomeTotal() | number:'1.2-2' }}</p>
        </div>

        <!-- Gastos del mes -->
        <div class="lg:col-span-2 xpb-bg-card rounded-xl px-1 py-3 lg:px-3 lg:py-6 shadow-sm border xpb-border">
          <div class="flex items-center gap-2 mb-2 lg:mb-3">
            <div class="hidden lg:block">
              <span class="material-icons text-[var(--xpb-expense)] text-xl">trending_down</span>
            </div>
            <p class="text-xs xpb-text-secondary uppercase tracking-wide whitespace-nowrap hidden lg:block">Gastos del Mes</p>
            <p class="text-[0.6rem] xpb-text-secondary uppercase tracking-wide font-semibold w-full text-center lg:hidden">GASTOS</p>
          </div>
          <p class="text-[0.65rem] lg:text-xl font-semibold text-[var(--xpb-expense)] mb-1 whitespace-nowrap text-center lg:text-left">- PEN {{ expenseTotal() | number:'1.2-2' }}</p>
        </div>
      }
    </div>

    @if (!dashboardState.isLoadingDashboardData() && !dashboardState.errorDashboardData() && dashboardData()) {
      <!-- Segunda fila: Gastos por categoría y Deuda en tarjetas -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Deuda total en tarjetas -->
        <div class="order-1 lg:order-2 xpb-bg-card rounded-xl p-6 shadow-sm border xpb-border flex flex-col justify-between h-full">
          <!-- Vista Desktop -->
          <div class="hidden lg:block">
            <h2 class="text-lg font-semibold xpb-text-primary mb-2">Deuda actual en tarjetas</h2>
            <p class="text-sm xpb-text-secondary mb-6">Crédito utilizado</p>

            <div class="space-y-5 lg:min-h-[100px]">
              @for (creditCard of creditCards(); track creditCard.resourceCode) {
                <div>
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium xpb-text-primary">{{ creditCard.name }}</p>
                    <p 
                      [class]="getPercentajeCreditUsed(creditCard) > 50 ? 'text-[var(--xpb-expense)]' : 'text-[var(--xpb-income)]'"
                      class="text-sm font-semibold">{{ getPercentajeCreditUsed(creditCard) | number:'1.0-0' }}%</p>
                  </div>
                  <div class="h-2 xpb-bg-main rounded-full overflow-hidden">
                    <div 
                        [class]="getPercentajeCreditUsed(creditCard) > 50 ? 'bg-[var(--xpb-expense)]' : 'bg-[var(--xpb-income)]'"
                        [style.width.%]="getPercentajeCreditUsed(creditCard)"
                        class="h-full">
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Total adeudado -->
            <div class="mt-6 pt-6 border-t xpb-border">
              <div class="flex items-center justify-between mb-4">
                <p class="text-sm xpb-text-secondary">Total adeudado</p>
                <p class="text-xl font-bold xpb-text-primary">PEN {{ totalCreditUsed() | number:'1.2-2' }}</p>
              </div>
            </div>
          </div>

          <!-- Vista Responsive -->
          <div class="lg:hidden">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-[0.875rem] font-semibold xpb-text-primary">Deuda en Tarjetas</h2>
              <p class="text-sm font-semibold text-[var(--xpb-expense)]">{{ percentajeCreditUsed() | number:'1.0-0' }}%</p>
            </div>
            
            <div class="h-3 xpb-bg-main rounded-full overflow-hidden mb-3">
              <div class="h-full bg-[var(--xpb-expense)]" [style.width.%]="percentajeCreditUsed()"></div>
            </div>
            
            <div class="flex items-center justify-between">
              <p class="text-xs xpb-text-secondary">Disponible: <span class="font-semibold xpb-text-primary">PEN {{ totalCreditLimit() - totalCreditUsed() | number:'1.2-2' }}</span></p>
              <p class="text-xs xpb-text-secondary">Límite: <span class="font-semibold xpb-text-primary">PEN {{ totalCreditLimit() | number:'1.2-2' }}</span></p>
            </div>
          </div>
        </div>

        <!-- Gastos por categoría -->
        <div class="order-2 lg:order-1 lg:col-span-2 xpb-bg-card rounded-xl p-6 shadow-sm border xpb-border">
          <h2 class="text-[0.875rem] lg:text-lg font-semibold xpb-text-primary mb-1 lg:mb-2">Gastos por categoría</h2>
          <p class="text-[0.75rem] xpb-text-secondary mb-6">Distribución mensual de tus consumos</p>

          <div class="grid grid-cols-2 md:grid-cols-2 gap-4 md:gap-8 items-center">
            <!-- Gráfico de dona -->
            <div class="flex justify-center items-center">
              <div class="relative" style="width: 150px; height: 150px;">
                <canvas id="expenseChart" class="lg:!w-[200px] lg:!h-[200px]" width="150" height="150"></canvas>
              </div>
            </div>

            <!-- Lista de categorías -->
            <div class="space-y-2 md:space-y-4">
              @for (category of categories(); track category.resourceCode) {
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2 flex-1 min-w-0">
                    <div class="w-2 h-2 md:w-3 md:h-3 rounded-full flex-shrink-0" [style.background-color]="category.color"></div>
                    <span class="text-xs md:text-sm xpb-text-primary truncate">{{ category.name }}</span>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <!-- Vista responsive: solo porcentaje -->
                    <p class="text-xs md:hidden font-semibold xpb-text-primary whitespace-nowrap">
                      {{ getPercentageCategoryAmount(category.amount) | number:'1.1-1' }}%
                    </p>
                    <!-- Vista desktop: monto completo -->
                    <p class="hidden md:block text-sm font-semibold xpb-text-primary whitespace-nowrap">
                      PEN {{ category.amount.toLocaleString('es-ES', { minimumFractionDigits: 2 }) }}
                      <span class="text-xs xpb-text-secondary ml-1">({{ getPercentageCategoryAmount(category.amount) | number:'1.1-1' }}%)</span>
                    </p>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Tercera fila: Últimas transacciones -->
      <div class="xpb-bg-card rounded-xl p-6 shadow-sm border xpb-border">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-[0.875rem] lg:text-lg font-semibold xpb-text-primary">Últimas transacciones</h2>
          <a routerLink="/landing/transaction" class="text-[0.75rem] text-[var(--xpb-primary)] hover:text-[var(--xpb-primary-hover)] font-medium inline-flex items-center gap-1">
            Ver todas
            <span style="font-size: 0.5rem;" class="material-icons">arrow_forward</span>
          </a>
        </div>

        <!-- Tabla de transacciones (Desktop) -->
        <div class="overflow-x-auto hidden md:block">
          <table class="w-full">
            <thead>
              <tr class="border-b xpb-border">
                <th class="text-left py-3 px-2 text-xs font-semibold xpb-text-secondary uppercase tracking-wider">Detalle</th>
                <th class="text-center py-3 px-2 text-xs font-semibold xpb-text-secondary uppercase tracking-wider">Categoría</th>
                <th class="text-center py-3 px-2 text-xs font-semibold xpb-text-secondary uppercase tracking-wider">Fecha</th>
                <th class="text-right py-3 px-2 text-xs font-semibold xpb-text-secondary uppercase tracking-wider">Monto</th>
              </tr>
            </thead>
            <tbody>
              @for (transaction of transactions(); track transaction.resourceCode) {
                <tr class="border-b xpb-border hover:xpb-bg-main transition-colors">
                  <td class="text-left py-4 px-2 text-sm xpb-text-primary max-w-xs">
                    <div class="flex items-start gap-1.5 flex-row">
                      <span class="inline-block px-4 py-1 rounded-full text-[11px] sm:text-xs font-medium truncate" 
                            [ngStyle]="{
                                'background-color': 'color-mix(in srgb, var(--' + getTransactionBgColorClass(transaction.transactionType) + ') 10%, transparent)',
                                'color': 'color-mix(in srgb, var(--' + getTransactionBgColorClass(transaction.transactionType) + ') 50%, transparent)'
                              }"> 
                            {{ getTransactionTypeLabel(transaction.transactionType) }}
                      </span>
                      @if (transaction.description) {
                        <span class="font-medium xpb-text-primary truncate">{{ transaction.description }}</span>
                      }
                    </div>
                  </td>
                  <td class="text-center py-4 px-2 text-sm xpb-text-secondary">
                    @if (transaction.category) {
                      <span class="inline-block px-4 py-1 rounded-full text-[11px] sm:text-xs font-medium text-black/50 truncate" 
                            [ngStyle]="{
                                'background-color': 'color-mix(in srgb, ' + transaction.category.color + ' 30%, transparent)'
                              }"> 
                            {{ transaction.category.name }}
                      </span>
                    }
                  </td>
                  <td class="text-center py-4 px-2 text-sm xpb-text-secondary">{{ formatDate(transaction.transactionDateTimestamp) }}</td>
                  <td class="text-right py-4 px-2 text-sm font-semibold truncate" 
                      [class]="transaction.transactionType === transactionType.INCOME ? 'text-[var(--xpb-income)]' : transaction.transactionType === transactionType.EXPENSE ? 'text-[var(--xpb-expense)]' : ''">
                    @if (transaction.transactionType === transactionType.INCOME) {
                      +
                    } @else if (transaction.transactionType === transactionType.EXPENSE) {
                      -
                    }
                    PEN {{ transaction.amount.toLocaleString('es-ES', { minimumFractionDigits: 2 }) }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Cards de transacciones (Responsive) -->
        <div class="md:hidden space-y-3">
          @for (transaction of transactions().slice(0, 5); track transaction.resourceCode) {
            <div class="xpb-bg-main rounded-lg py-4 px-2 border xpb-border hover:shadow-sm transition-shadow">
              <div class="flex items-center gap-3">
                <!-- Icono del tipo de transacción -->
                <div class="flex-shrink-0 rounded-full flex items-center justify-center">
                  <span class="material-icons text-xs"
                        [ngStyle]="{
                          'color': 'color-mix(in srgb, var(--' + getTransactionBgColorClass(transaction.transactionType) + ') 50%, transparent)'
                        }">
                    {{ transactionType.getTransactionIcon(transaction.transactionType) }}
                  </span>
                </div>

                <!-- Detalles de la transacción -->
                <div class="flex-1 min-w-0">
                  @if (transaction.description) {
                    <p class="text-[0.75rem] font-medium xpb-text-primary truncate">{{ transaction.description }}</p>
                  }
                  <div class="flex items-center gap-2 mt-1">
                    @if (transaction.category) {
                      <span class="xpb-text-secondary w-2.5 h-2.5 rounded-full"
                        [ngStyle]="{
                                  'background-color': 'color-mix(in srgb, ' + transaction.category.color + ' 100%, transparent)'
                                }">
                      </span>
                    } @else {
                      <span class="xpb-text-secondary w-2.5 h-2.5 rounded-full"
                        [ngStyle]="{
                                  'background-color': 'transparent',
                                  'border': '0.1px solid black'
                                }">
                      </span>
                    }
                    <span class="text-[0.7rem] xpb-text-secondary truncate">{{ formatDate(transaction.transactionDateTimestamp) }}</span>
                  </div>
                </div>

                <!-- Monto -->
                <div class="flex-shrink-0 text-right flex items-center">
                  <p class="text-xs font-semibold whitespace-nowrap"
                    [class]="transaction.transactionType === transactionType.INCOME ? 'text-[var(--xpb-income)]' : transaction.transactionType === transactionType.EXPENSE ? 'text-[var(--xpb-expense)]' : ''">
                    @if (transaction.transactionType === transactionType.INCOME) {
                      +
                    } @else if (transaction.transactionType === transactionType.EXPENSE) {
                      -
                    }
                    PEN {{ transaction.amount.toLocaleString('es-ES', { minimumFractionDigits: 2 }) }}
                  </p>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>
